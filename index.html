<!doctype html>
<html>

<head>
  <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/symbola" type="text/css" />
  <link rel="stylesheet" href="style.css">
  <!-- Load nerdamer core-->
  <!-- largest number is about 10^308, beyond is infinity-->
  <!-- Smallest number is about -10^308, below is -infinity-->
  <!-- Smallest fraction is about 10^-308, below is 0-->
  <script src="/nerdamer/nerdamer.core.js"></script>
  <!-- LOAD ADD-ONS -->
  <script src="/nerdamer/Algebra.js"></script>
  <script src="/nerdamer/Calculus.js"></script>
  <script src="/nerdamer/Solve.js"></script>
  <script src="/nerdamer/Extra.js"></script>
  <!-- <script src="/js/script.js"></script> -->
</head>

<body>
  <div id="mathField">
    <!-- <input type="text" size="30" autofocus spellcheck="false" id="input-0"> -->
     <!-- <span id="output-0" class="output"></span> -->
  </div>
  <!-- <button id="evalBtn">Evaluate</button> -->
  <script>
    let mathField = document.querySelector("#mathField");
    let inputNumber = 0;
    //create initial input and output on page load
    document.addEventListener("DOMContentLoaded", function(event){
        createNewField();
    })
    //listen for keyboard events in the input box
    mathField.addEventListener("keyup", function(event){
        //if key pressed is ENTER, UP Arrow, or DOWN Arrow, return immediately
        if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40){
            return;
        }
        let currentInput = event.target;
        let inputId = currentInput.getAttribute("id");
        let currentInputNumber = Number(inputId.substring(inputId.length-1));//retrieve the last character
        if (mathField.querySelector("span#output-" + currentInputNumber) !== null){
            let result = evalExpr(currentInput);
            let output = mathField.querySelectorAll("span")[currentInputNumber];
            console.log("result " + result);
            output.innerHTML = " = " + result;
        }
    });
    mathField.addEventListener("keydown", function(event) {
      let currentInput = event.target;
      let inputId = currentInput.getAttribute("id");
      let currentInputNumber = Number(inputId.substring(inputId.length-1));//retrieve the last character
      if (event.keyCode == 13) { //ENTER key is pressed
        createNewField();
    } else if(event.keyCode == 38){//UP arrow key is pressed
        event.preventDefault();
        if (inputNumber > 0){
            let previousInput = mathField.querySelector("#input-" + (currentInputNumber - 1));
            previousInput.focus();
            moveCaretToEnd(previousInput);
        }
    } else if(event.keyCode == 40){//DOWN arrow key is pressed
        event.preventDefault();
        if (currentInputNumber < inputNumber - 1){
            let nextInput = mathField.querySelector("#input-" + (currentInputNumber + 1));
            nextInput.focus();
            moveCaretToEnd(nextInput);
        } else{
            createNewField();
        }
    }
    });
    let createNewInput = function(){
        let newInput = document.createElement("input");
        newInput.setAttribute("type", "text");
        newInput.setAttribute("size", "30");
        newInput.setAttribute("spellcheck", false);
        newInput.setAttribute("id", "input-" + inputNumber);
        return newInput;
    }
    let createNewOutput = function(){
        let newOutput = document.createElement("span");
        newOutput.setAttribute("id", "output-" + inputNumber);
        return newOutput;
    }
    let createNewField = function(){
        let newInput = createNewInput();
        let newOutput = createNewOutput();
        mathField.appendChild(newInput);
        mathField.appendChild(newOutput);
        newInput.focus();
        inputNumber++;
    }
    let moveCaretToEnd = function(input){
        input.setSelectionRange(input.value.length, input.value.length);
    }
    let evalExpr = function(input) {
      let expr = input.value;
      console.log("expr: " + expr);
      let result = nerdamer(expr).evaluate() + "";
      return result;
    }
  </script>
</body>

</html>
